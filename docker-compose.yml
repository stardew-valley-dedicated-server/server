services:
  # Main game server
  server:
    image: sdvd/server:${IMAGE_VERSION:-latest}
    container_name: sdvd-server
    stdin_open: true
    tty: true
    ports:
      - ${GAME_PORT:-24642}:24642/udp
      - ${VNC_PORT:-5800}:5800
    cap_add:
      # Required to sync time, ensures GOG GalaxyAuth works
      # TODO: Document/mention underlying library + extra debug info file for GOG, in case shtf
      - SYS_TIME
    volumes:
      - game-data:/data/game
      - saves:/config/xdg/config/StardewValley
      - server-status:/tmp
    environment:
      # Steam auth service URL (for runtime ticket requests)
      STEAM_AUTH_URL: "http://steam-auth:3001"
      # Server configuration
      VNC_PASSWORD: "${VNC_PASSWORD:-}"
      DISABLE_RENDERING: "${DISABLE_RENDERING:-true}"
      ALLOW_IP_CONNECTIONS: "${ALLOW_IP_CONNECTIONS:-false}"
    depends_on:
      steam-auth:
        condition: service_healthy
    restart: unless-stopped

  steam-auth:
    build:
      context: ./tools/steam-service
      dockerfile: Dockerfile
    image: sdvd/steam-service:${IMAGE_VERSION:-latest}
    container_name: sdvd-steam-auth
    stdin_open: true
    tty: true
    ports:
      - "${STEAM_AUTH_PORT:-3001}:3001"
    volumes:
      - steam-session:/data/steam-session
      - game-data:/data/game
    environment:
      PORT: "3001"
      GAME_DIR: "/data/game"
      SESSION_DIR: "/data/steam-session"
      STEAM_USERNAME: "${STEAM_USERNAME:-}"
      STEAM_PASSWORD: "${STEAM_PASSWORD:-}"
      STEAM_REFRESH_TOKEN: "${STEAM_REFRESH_TOKEN:-}"
    restart: unless-stopped

  # Discord bot for server status display
  discord-bot:
    build:
      context: ./tools/discord-bot
      dockerfile: Dockerfile
    image: sdvd/discord-bot:${IMAGE_VERSION:-latest}
    container_name: sdvd-discord-bot
    volumes:
      - server-status:/tmp:ro
    environment:
      DISCORD_BOT_TOKEN: "${DISCORD_BOT_TOKEN:-}"
      STATUS_FILE_PATH: "/tmp/server-status.json"
      # Min 20s to respect Discord rate limits, default 30s
      UPDATE_INTERVAL_MS: "30000"
    depends_on:
      - server
    # on-failure: won't restart when disabled (exit 0), will restart on crashes
    restart: on-failure

volumes:
  steam-session:
  game-data:
  saves:
  server-status:
