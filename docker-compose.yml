services:
  # Main game server
  server:
    image: sdvd/server:${IMAGE_VERSION:-latest}
    container_name: sdvd-server
    stdin_open: true
    tty: true
    ports:
      - "${VNC_PORT:-5800}:5800"
      - "${API_PORT:-8080}:8080"
      # Steam SDR ports (used by GameServer.Init for relay network)
      - "${SDR_GAME_PORT:-24642}:24642/udp"
      - "${SDR_QUERY_PORT:-27015}:27015/udp"
    cap_add:
      # Required to sync time, ensures GOG GalaxyAuth works
      - SYS_TIME
    volumes:
      - game-data:/data/game
      - saves:/config/xdg/config/StardewValley
      - settings:/data/settings
    environment:
      # Steam auth service URL (for runtime ticket requests)
      STEAM_AUTH_URL: "http://steam-auth:3001"
      # Server configuration
      VNC_PASSWORD: "${VNC_PASSWORD:-}"
      DISABLE_RENDERING: "${DISABLE_RENDERING:-true}"
      # Game settings file path (auto-created with defaults if missing)
      SETTINGS_PATH: "/data/settings/server-settings.json"
      # HTTP API for external tools and automation
      API_ENABLED: "${API_ENABLED:-true}"
      API_PORT: "${API_PORT:-8080}"
    depends_on:
      steam-auth:
        condition: service_healthy
    restart: unless-stopped

  steam-auth:
    build:
      context: ./tools/steam-service
      dockerfile: Dockerfile
    image: sdvd/steam-service:${IMAGE_VERSION:-latest}
    container_name: sdvd-steam-auth
    stdin_open: true
    tty: true
    expose:
      - "3001"
    volumes:
      - steam-session:/data/steam-session
      - game-data:/data/game
    environment:
      PORT: "3001"
      GAME_DIR: "/data/game"
      SESSION_DIR: "/data/steam-session"
      STEAM_USERNAME: "${STEAM_USERNAME:-}"
      STEAM_PASSWORD: "${STEAM_PASSWORD:-}"
      STEAM_REFRESH_TOKEN: "${STEAM_REFRESH_TOKEN:-}"
    restart: unless-stopped

  # Discord bot for server status display
  discord-bot:
    build:
      context: ./tools/discord-bot
      dockerfile: Dockerfile
    image: sdvd/discord-bot:${IMAGE_VERSION:-latest}
    container_name: sdvd-discord-bot
    environment:
      DISCORD_BOT_TOKEN: "${DISCORD_BOT_TOKEN:-}"
      # HTTP API URL for fetching server status
      API_URL: "http://server:8080"
      # Min 20s to respect Discord rate limits, default 30s
      UPDATE_INTERVAL_MS: "30000"
    depends_on:
      - server
    # on-failure: won't restart when disabled (exit 0), will restart on crashes
    restart: on-failure

volumes:
  steam-session:
  game-data:
  saves:
  settings:
