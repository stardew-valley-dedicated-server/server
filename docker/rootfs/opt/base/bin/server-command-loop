#!/bin/bash

# Take session name as first argument
SESSION_NAME="$1"
INPUT_FIFO="/tmp/smapi-input"
PASSWORD_MODE_FILE="/tmp/smapi-password-mode"

send_to_server() {
    local command="$1"
    echo "$command" >> "$INPUT_FIFO"
}

# Read password with asterisk masking and backspace support
read_password() {
    local prompt="$1"
    local password=""
    local char

    printf "%s" "$prompt"

    while IFS= read -rsn1 char; do
        # Enter key (empty char)
        if [[ -z "$char" ]]; then
            break
        fi

        # Backspace or Delete (ASCII 127 or ctrl-h)
        if [[ "$char" == $'\x7f' ]] || [[ "$char" == $'\b' ]]; then
            if [ -n "$password" ]; then
                password="${password%?}"  # Remove last character
                printf "\b \b"  # Erase asterisk from display
            fi
        else
            # Regular character
            password+="$char"
            printf "*"
        fi
    done

    echo  # Newline after password input
    REPLY="$password"
}

clear
stty -echoctl  # hide ^C

# Trap Ctrl+C to cancel the current input line
handle_sigint() {
    printf "\r\033[Kserver> "
}
trap 'handle_sigint' INT

while true; do
    # Check if next read should be in password mode
    if [ -f "$PASSWORD_MODE_FILE" ]; then
        # Delete signal file so we don't stay in password mode
        rm -f "$PASSWORD_MODE_FILE"

        # Password mode: use asterisk-masked input
        read_password "password> "
    else
        # Normal mode: use regular input with readline support
        if ! read -r -e -p "server> "; then
            echo
            tmux kill-session -t "$SESSION_NAME" 2>/dev/null || exit 0
            break
        fi
    fi

    clear

    case "$REPLY" in
        "cli exit"|"cli quit"|"cli detach")
            tmux detach-client 2>/dev/null || exit 0
            break
            ;;
        "cli clear")
            clear
            continue
            ;;
        *)
            send_to_server "$REPLY"
            ;;
    esac
done
