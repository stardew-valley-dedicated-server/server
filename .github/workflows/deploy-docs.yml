name: Deploy Documentation

on:
  workflow_call:
    inputs:
      version:
        description: 'Which version was just built (latest or preview)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      rebuild_latest:
        description: 'Rebuild latest docs from Docker image'
        required: false
        default: false
        type: boolean
      rebuild_preview:
        description: 'Rebuild preview docs from Docker image'
        required: false
        default: false
        type: boolean
      use_preview_for_latest:
        description: 'Build latest docs from preview image (for bootstrapping before first release)'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-docs
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

jobs:
  # Optionally rebuild docs if requested via manual trigger
  build-latest:
    name: Build Latest Docs
    if: inputs.rebuild_latest == true || inputs.use_preview_for_latest == true
    uses: ./.github/workflows/build-docs.yml
    with:
      version: latest
      image_tag: ${{ inputs.use_preview_for_latest == true && 'preview' || 'latest' }}
    secrets: inherit

  build-preview:
    name: Build Preview Docs
    if: inputs.rebuild_preview == true || inputs.use_preview_for_latest == true
    uses: ./.github/workflows/build-docs.yml
    with:
      version: preview
      image_tag: preview
    secrets: inherit

  deploy:
    name: Deploy to GitHub Pages
    needs: [build-latest, build-preview]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # Try to download from current workflow run first
      # This works when called from build-release.yml/build-preview.yml which run build-docs first
      - name: Download latest docs (current run)
        id: current-latest
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: docs-latest
          path: dist
        continue-on-error: true

      - name: Download preview docs (current run)
        id: current-preview
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: docs-preview
          path: dist/preview
        continue-on-error: true

      # If not found in current run, fetch from previous workflow runs
      # Try build-release.yml first (primary source for latest docs)
      - name: Download latest docs (from release workflow)
        id: release-latest
        if: steps.current-latest.outcome != 'success'
        uses: dawidd6/action-download-artifact@5c98f0b039f36ef966fdb7dfa9779262785ecb05 # v14
        with:
          workflow: build-release.yml
          name: docs-latest
          path: dist
          if_no_artifact_found: ignore
          allow_forks: false
        continue-on-error: true

      # Fallback: check deploy-docs.yml for manually rebuilt latest docs
      - name: Download latest docs (from manual rebuild)
        if: steps.current-latest.outcome != 'success' && steps.release-latest.outcome != 'success'
        uses: dawidd6/action-download-artifact@5c98f0b039f36ef966fdb7dfa9779262785ecb05 # v14
        with:
          workflow: deploy-docs.yml
          name: docs-latest
          path: dist
          if_no_artifact_found: warn
          allow_forks: false

      # Try build-preview.yml first (primary source for preview docs)
      - name: Download preview docs (from build-preview workflow)
        id: build-preview-artifact
        if: steps.current-preview.outcome != 'success'
        uses: dawidd6/action-download-artifact@5c98f0b039f36ef966fdb7dfa9779262785ecb05 # v14
        with:
          workflow: build-preview.yml
          name: docs-preview
          path: dist/preview
          if_no_artifact_found: ignore
          allow_forks: false
        continue-on-error: true

      # Fallback: check deploy-docs.yml for manually rebuilt preview docs
      - name: Download preview docs (from manual rebuild)
        if: steps.current-preview.outcome != 'success' && steps.build-preview-artifact.outcome != 'success'
        uses: dawidd6/action-download-artifact@5c98f0b039f36ef966fdb7dfa9779262785ecb05 # v14
        with:
          workflow: deploy-docs.yml
          name: docs-preview
          path: dist/preview
          if_no_artifact_found: warn
          allow_forks: false

      - name: Check artifacts exist
        id: check
        run: |
          VERSION="${{ inputs.version }}"
          HAS_LATEST=false
          HAS_PREVIEW=false

          # Check for latest docs
          if [ -d "dist" ] && [ -n "$(ls -A dist 2>/dev/null | grep -v preview)" ]; then
            echo "Latest docs: $(du -sh dist --exclude=dist/preview 2>/dev/null | cut -f1 || du -sh dist | cut -f1)"
            HAS_LATEST=true
          fi

          # Check for preview docs
          if [ -d "dist/preview" ] && [ -n "$(ls -A dist/preview 2>/dev/null)" ]; then
            echo "Preview docs: $(du -sh dist/preview | cut -f1)"
            HAS_PREVIEW=true
          fi

          echo "has_latest=$HAS_LATEST" >> $GITHUB_OUTPUT
          echo "has_preview=$HAS_PREVIEW" >> $GITHUB_OUTPUT

          # Latest docs are required for deployment (main site content)
          if [ "$HAS_LATEST" != "true" ]; then
            echo "::warning::No docs-latest artifact found. The artifact may have expired (14 day retention)."
            echo "::warning::Skipping deployment. To fix: Run deploy-docs workflow manually with rebuild_latest=true, or trigger a release."
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Preview docs are optional but warn if missing
          if [ "$HAS_PREVIEW" != "true" ]; then
            echo "::warning::No preview docs artifact found. Preview docs will not be available."
          fi

          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Setup Pages
        if: steps.check.outputs.should_deploy == 'true'
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Upload merged artifact
        if: steps.check.outputs.should_deploy == 'true'
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        if: steps.check.outputs.should_deploy == 'true'
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      - name: Build summary
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          echo "### Documentation Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Versions deployed:**" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.has_latest }}" == "true" ]; then
            echo "- Latest: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check.outputs.has_preview }}" == "true" ]; then
            echo "- Preview: ${{ steps.deployment.outputs.page_url }}preview/" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skipped summary
        if: steps.check.outputs.should_deploy != 'true'
        run: |
          echo "### Documentation Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No docs-latest artifact was found. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "- The artifact expired (14 day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- No release has been published yet" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To fix:** Run the deploy-docs workflow manually with \`rebuild_latest=true\`, or trigger a release." >> $GITHUB_STEP_SUMMARY

      - name: Discord notification
        if: success() && steps.check.outputs.should_deploy == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "Documentation Updated",
                  "color": 3447003,
                  "fields": [
                    {"name": "View Docs", "value": "[stardew-valley-dedicated-server.github.io/server](${{ steps.deployment.outputs.page_url }})"}
                  ]
                }]
              }' \
              "$DISCORD_WEBHOOK"
          fi
