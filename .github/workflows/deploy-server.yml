name: Deploy Server

on:
  workflow_run:
    workflows: ["Preview Build"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:
    inputs:
      instance:
        description: 'Which instance to deploy'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - latest
          - all
      skip_graceful_shutdown:
        description: 'Skip graceful shutdown (emergency deploy)'
        required: false
        default: false
        type: boolean

# Queue deployments - don't cancel in-progress deploys (could leave server in broken state)
concurrency:
  group: server-deploy-${{ github.event.inputs.instance || 'auto' }}
  cancel-in-progress: false

permissions: {}

jobs:
  # Determine which instances to deploy
  prepare:
    name: Prepare deployment matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_instances: ${{ steps.set-matrix.outputs.has_instances }}
    steps:
      - name: Set deployment matrix
        id: set-matrix
        env:
          # Enable/disable instances via repository variables (Settings > Variables)
          # Set to 'true' to enable, anything else to disable
          PREVIEW_ENABLED: ${{ vars.DEPLOY_PREVIEW_ENABLED || 'true' }}
          LATEST_ENABLED: ${{ vars.DEPLOY_LATEST_ENABLED || 'false' }}
          TRIGGER: ${{ github.event_name }}
          SELECTED_INSTANCE: ${{ github.event.inputs.instance }}
        run: |
          instances='[]'

          # Preview instance configuration
          if [[ "$TRIGGER" == "workflow_dispatch" ]]; then
            # Manual trigger - deploy selected instance(s)
            if [[ "$SELECTED_INSTANCE" == "preview" || "$SELECTED_INSTANCE" == "all" ]]; then
              if [[ "$PREVIEW_ENABLED" == "true" ]]; then
                instances=$(echo "$instances" | jq -c '. + [{"name": "preview", "image_tag": "preview", "path_secret": "DEPLOY_PATH_PREVIEW", "path_default": "/srv/sdvd/preview"}]')
              fi
            fi
            if [[ "$SELECTED_INSTANCE" == "latest" || "$SELECTED_INSTANCE" == "all" ]]; then
              if [[ "$LATEST_ENABLED" == "true" ]]; then
                instances=$(echo "$instances" | jq -c '. + [{"name": "latest", "image_tag": "latest", "path_secret": "DEPLOY_PATH_LATEST", "path_default": "/srv/sdvd/latest"}]')
              fi
            fi
          else
            # Automatic trigger (workflow_run) - only deploy preview
            if [[ "$PREVIEW_ENABLED" == "true" ]]; then
              instances=$(echo "$instances" | jq -c '. + [{"name": "preview", "image_tag": "preview", "path_secret": "DEPLOY_PATH_PREVIEW", "path_default": "/srv/sdvd/preview"}]')
            fi
          fi

          echo "matrix={\"instance\":$instances}" >> $GITHUB_OUTPUT

          # Check if we have any instances to deploy
          if [[ "$instances" == "[]" ]]; then
            echo "has_instances=false" >> $GITHUB_OUTPUT
            echo "::warning::No instances enabled for deployment"
          else
            echo "has_instances=true" >> $GITHUB_OUTPUT
            echo "Instances to deploy: $instances"
          fi

  deploy:
    name: Deploy ${{ matrix.instance.name }}
    needs: prepare
    if: >
      needs.prepare.outputs.has_instances == 'true' &&
      (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    permissions:
      contents: read

    env:
      DEPLOY_PATH: ${{ secrets[matrix.instance.path_secret] || matrix.instance.path_default }}
      IMAGE_TAG: ${{ matrix.instance.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          sparse-checkout: |
            docker-compose.yml
          sparse-checkout-cone-mode: false

      # ============================================================
      # PLACEHOLDER: Future Graceful Shutdown Hook
      # ============================================================
      - name: Graceful shutdown preparation
        if: github.event.inputs.skip_graceful_shutdown != 'true'
        run: |
          echo "::notice::Graceful shutdown hook placeholder for ${{ matrix.instance.name }}"

      - name: Create .env file
        run: |
          echo "::group::Generate .env file for ${{ matrix.instance.name }}"
          cat > .env << EOF
          # Auto-generated by GitHub Actions deploy workflow
          # Instance: ${{ matrix.instance.name }}
          IMAGE_VERSION=${{ env.IMAGE_TAG }}
          STEAM_USERNAME=${{ secrets.DEPLOY_STEAM_USERNAME }}
          STEAM_PASSWORD=${{ secrets.DEPLOY_STEAM_PASSWORD }}
          STEAM_REFRESH_TOKEN=${{ secrets.DEPLOY_STEAM_REFRESH_TOKEN }}
          VNC_PASSWORD=${{ secrets.DEPLOY_VNC_PASSWORD }}
          GAME_PORT=24642
          VNC_PORT=5800
          STEAM_AUTH_PORT=3001
          DISABLE_RENDERING=true
          EOF
          sed -i 's/^          //' .env
          echo "::endgroup::"

      - name: Create deploy directory
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f # v1.2.2
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: mkdir -p ${{ env.DEPLOY_PATH }}

      - name: Copy files to server
        uses: appleboy/scp-action@ff85246acaad7bdce478db94a363cd2bf7c90345 # v1.0.0
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          source: "docker-compose.yml,.env"
          target: ${{ env.DEPLOY_PATH }}

      - name: Pull and restart containers
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f # v1.2.2
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "::group::Pull latest images"
            docker compose pull
            echo "::endgroup::"

            echo "::group::Stop existing containers"
            docker compose down --timeout 30 || true
            echo "::endgroup::"

            echo "::group::Start containers"
            docker compose up -d
            echo "::endgroup::"

            echo "::group::Cleanup old images"
            docker image prune -f
            echo "::endgroup::"

      - name: Verify deployment
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f # v1.2.2
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "::group::Wait for containers to start"
            sleep 30
            echo "::endgroup::"

            echo "::group::Check container health"
            if docker compose ps | grep -qE "unhealthy|Exit"; then
              echo "::error::One or more containers are unhealthy or exited"
              docker compose logs --tail=50
              exit 1
            fi
            echo "All containers running successfully"
            docker compose ps
            echo "::endgroup::"

      - name: Build summary
        run: |
          echo "### Deployment Complete: ${{ matrix.instance.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Instance:** \`${{ matrix.instance.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image tag:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy path:** \`${{ env.DEPLOY_PATH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            jq -n \
              --arg instance "${{ matrix.instance.name }}" \
              --arg tag "${{ env.IMAGE_TAG }}" \
              --arg commit "${GITHUB_SHA:0:7}" \
              '{
                embeds: [{
                  title: "Server Deployed",
                  color: 3066993,
                  fields: [
                    {name: "Instance", value: $instance, inline: true},
                    {name: "Image", value: ("`" + $tag + "`"), inline: true},
                    {name: "Commit", value: ("`" + $commit + "`"), inline: true}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi

      - name: Discord notification (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            jq -n \
              --arg instance "${{ matrix.instance.name }}" \
              --arg commit "${GITHUB_SHA:0:7}" \
              '{
                embeds: [{
                  title: "Server Deployment Failed",
                  color: 15158332,
                  fields: [
                    {name: "Instance", value: $instance, inline: true},
                    {name: "Commit", value: ("`" + $commit + "`"), inline: true},
                    {name: "Status", value: "Check GitHub Actions logs"}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
