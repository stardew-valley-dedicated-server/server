name: Preview Build

on:
  push:
    branches:
      - master

# Prevent multiple builds from running simultaneously
concurrency:
  group: preview-build
  cancel-in-progress: true

jobs:
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      next_version: ${{ steps.version.outputs.next_version }}
      preview_version: ${{ steps.version.outputs.preview_version }}
      preview_number: ${{ steps.version.outputs.preview_number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for version calculation

      - name: Calculate next version
        id: version
        run: |
          # Get the latest release tag (exclude preview tags)
          LATEST_TAG=$(git tag -l 'v*' --sort=-version:refname | grep -v 'preview' | head -n 1)
          echo "Latest release tag: $LATEST_TAG"

          # Extract version number (remove 'v' prefix)
          CURRENT_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          echo "Current version: $CURRENT_VERSION"

          # Split version into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Get commits since last release tag
          COMMITS=$(git log $LATEST_TAG..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          # Determine bump type based on conventional commits
          BUMP_TYPE="patch"
          if echo "$COMMITS" | grep -qE "^feat(\(.+\))?!:|^BREAKING CHANGE:"; then
            BUMP_TYPE="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            BUMP_TYPE="minor"
          elif echo "$COMMITS" | grep -qE "^fix(\(.+\))?:"; then
            BUMP_TYPE="patch"
          fi

          echo "Bump type: $BUMP_TYPE"

          # Calculate next version
          if [ "$BUMP_TYPE" == "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" == "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEXT_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "Next version: $NEXT_VERSION"

          # Get current preview tag to determine counter
          PREVIEW_TAG=$(git tag -l 'preview-*' | head -n 1)
          if [ -n "$PREVIEW_TAG" ]; then
            # Parse existing tag: preview-{version}.{counter}
            PREVIEW_TAG_VERSION=$(echo "$PREVIEW_TAG" | sed 's/preview-\(.*\)\.[0-9]*$/\1/')
            PREVIEW_TAG_COUNTER=$(echo "$PREVIEW_TAG" | sed 's/.*\.\([0-9]*\)$/\1/')
            echo "Found preview tag: $PREVIEW_TAG (version: $PREVIEW_TAG_VERSION, counter: $PREVIEW_TAG_COUNTER)"

            if [ "$PREVIEW_TAG_VERSION" == "$NEXT_VERSION" ]; then
              # Same version, increment counter
              PREVIEW_NUMBER=$((PREVIEW_TAG_COUNTER + 1))
            else
              # Version changed, reset counter
              PREVIEW_NUMBER=1
            fi
          else
            # No preview tag exists yet
            PREVIEW_NUMBER=1
          fi
          echo "Preview number: $PREVIEW_NUMBER"

          # Create preview version
          PREVIEW_VERSION="$NEXT_VERSION-preview.$PREVIEW_NUMBER"
          echo "Preview version: $PREVIEW_VERSION"

          # Export variables
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "preview_version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT
          echo "preview_number=$PREVIEW_NUMBER" >> $GITHUB_OUTPUT

  build-server-preview:
    name: Build and Push Server Preview
    needs: calculate-version
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update version in files (for Docker build only)
        run: |
          PREVIEW_VERSION="${{ needs.calculate-version.outputs.preview_version }}"

          # Update manifest.json
          sed -i "s/\"Version\": \".*\"/\"Version\": \"$PREVIEW_VERSION\"/" mod/JunimoServer/manifest.json

          # Update csproj
          sed -i "s|<Version>.*</Version>|<Version>$PREVIEW_VERSION</Version>|g" mod/JunimoServer/JunimoServer.csproj

          echo "Updated files to version $PREVIEW_VERSION (not committed)"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: sdvd/server
          tags: |
            type=raw,value=preview
            type=raw,value=${{ needs.calculate-version.outputs.preview_version }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: true
          sbom: true
          secrets: |
            steam_username=${{ secrets.STEAM_USERNAME }}
            steam_password=${{ secrets.STEAM_PASSWORD }}
            steam_refresh_token=${{ secrets.STEAM_REFRESH_TOKEN }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update preview tracking tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete old preview tag if it exists
          git tag -d preview-* 2>/dev/null || true
          git push origin --delete $(git ls-remote --tags origin | grep 'preview-' | awk '{print $2}' | sed 's|refs/tags/||') 2>/dev/null || true

          # Create new tracking tag (format: preview-{version}.{counter})
          TRACKING_TAG="preview-${{ needs.calculate-version.outputs.next_version }}.${{ needs.calculate-version.outputs.preview_number }}"
          git tag "$TRACKING_TAG"
          git push origin "$TRACKING_TAG"

      - name: Build summary
        run: |
          echo "### Preview Build Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.calculate-version.outputs.preview_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Next Release:** \`${{ needs.calculate-version.outputs.next_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/server:preview\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/server:${{ needs.calculate-version.outputs.preview_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull sdvd/server:preview" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "Preview Build Published",
                "color": 16753920,
                "fields": [
                  {"name": "Version", "value": "`${{ needs.calculate-version.outputs.preview_version }}`", "inline": true},
                  {"name": "Image", "value": "`sdvd/server:preview`", "inline": true},
                  {"name": "Pull Command", "value": "```docker pull sdvd/server:preview```"}
                ],
                "footer": {"text": "Commit: ${{ github.sha }}"}
              }]
            }' \
            "$DISCORD_WEBHOOK"

  build-steam-service-preview:
    name: Build and Push Steam Service Preview
    needs: calculate-version
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: sdvd/steam-service
          tags: |
            type=raw,value=preview
            type=raw,value=${{ needs.calculate-version.outputs.preview_version }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./tools/steam-service
          file: ./tools/steam-service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: true
          sbom: true
          cache-from: type=gha,scope=steam-service
          cache-to: type=gha,mode=max,scope=steam-service

      - name: Build summary
        run: |
          echo "### Steam Service Preview Build Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.calculate-version.outputs.preview_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/steam-service:preview\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/steam-service:${{ needs.calculate-version.outputs.preview_version }}\`" >> $GITHUB_STEP_SUMMARY
