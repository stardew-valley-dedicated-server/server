name: PR Preview

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number to build and deploy'
        required: true
        type: number
      deploy_server:
        description: 'Deploy game server to PR environment'
        required: false
        default: false
        type: boolean
      deploy_docs:
        description: 'Deploy documentation preview'
        required: false
        default: false
        type: boolean

concurrency:
  group: pr-preview-${{ inputs.pr_number }}
  cancel-in-progress: true

permissions: {}

jobs:
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      pr_ref: ${{ steps.pr.outputs.ref }}
      pr_sha: ${{ steps.pr.outputs.sha }}
      pr_title: ${{ steps.pr.outputs.title }}
      image_tag: ${{ steps.pr.outputs.image_tag }}

    steps:
      - name: Get PR information
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)

          if [ -z "$PR_JSON" ] || [ "$PR_JSON" = "null" ]; then
            echo "::error::PR #$PR_NUMBER not found"
            exit 1
          fi

          STATE=$(echo "$PR_JSON" | jq -r '.state')
          if [ "$STATE" != "open" ]; then
            echo "::error::PR #$PR_NUMBER is not open (state: $STATE)"
            exit 1
          fi

          REF=$(echo "$PR_JSON" | jq -r '.head.ref')
          SHA=$(echo "$PR_JSON" | jq -r '.head.sha')
          TITLE=$(echo "$PR_JSON" | jq -r '.title')

          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "image_tag=pr-$PR_NUMBER" >> $GITHUB_OUTPUT

          echo "### PR Information" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** $TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** $REF" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA:** $SHA" >> $GITHUB_STEP_SUMMARY

  build-server:
    name: Build Server Image
    needs: validate-pr
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout PR
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.validate-pr.outputs.pr_sha }}

      - name: Update version in files
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          VERSION="0.0.0-pr.$PR_NUMBER"

          # Update manifest.json
          sed -i "s/\"Version\": \".*\"/\"Version\": \"$VERSION\"/" mod/JunimoServer/manifest.json

          # Update csproj
          sed -i "s|<Version>.*</Version>|<Version>$VERSION</Version>|g" mod/JunimoServer/JunimoServer.csproj

          echo "Updated files to version $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: sdvd/server
          tags: |
            type=raw,value=${{ needs.validate-pr.outputs.image_tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: true
          sbom: true
          secrets: |
            steam_username=${{ secrets.STEAM_USERNAME }}
            steam_password=${{ secrets.STEAM_PASSWORD }}
            steam_refresh_token=${{ secrets.STEAM_REFRESH_TOKEN }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build summary
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
        run: |
          echo "### Server Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`sdvd/server:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull sdvd/server:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  build-steam-service:
    name: Build Steam Service Image
    needs: validate-pr
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout PR
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.validate-pr.outputs.pr_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: sdvd/steam-service
          tags: |
            type=raw,value=${{ needs.validate-pr.outputs.image_tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ./tools/steam-service
          file: ./tools/steam-service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: true
          sbom: true
          cache-from: type=gha,scope=steam-service
          cache-to: type=gha,mode=max,scope=steam-service

      - name: Build summary
        env:
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
        run: |
          echo "### Steam Service Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`sdvd/steam-service:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY

  build-discord-bot:
    name: Build Discord Bot Image
    needs: validate-pr
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout PR
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.validate-pr.outputs.pr_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: sdvd/discord-bot
          tags: |
            type=raw,value=${{ needs.validate-pr.outputs.image_tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ./tools/discord-bot
          file: ./tools/discord-bot/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: true
          sbom: true
          cache-from: type=gha,scope=discord-bot
          cache-to: type=gha,mode=max,scope=discord-bot

      - name: Build summary
        env:
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
        run: |
          echo "### Discord Bot Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`sdvd/discord-bot:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY

  deploy-server:
    name: Deploy PR Server
    needs: [validate-pr, build-server, build-steam-service, build-discord-bot]
    if: inputs.deploy_server == true
    runs-on: ubuntu-latest
    timeout-minutes: 15

    environment: pr-preview

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.validate-pr.outputs.pr_sha }}
          sparse-checkout: |
            docker-compose.yml
          sparse-checkout-cone-mode: false

      - name: Create .env file
        env:
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
          PR_NUMBER: ${{ inputs.pr_number }}
          DEPLOY_GAME_PORT: ${{ secrets.DEPLOY_GAME_PORT }}
          DEPLOY_VNC_PORT: ${{ secrets.DEPLOY_VNC_PORT }}
          DEPLOY_STEAM_AUTH_PORT: ${{ secrets.DEPLOY_STEAM_AUTH_PORT }}
        run: |
          # Validate required secrets
          missing=""
          [[ -z "$DEPLOY_GAME_PORT" ]] && missing="$missing DEPLOY_GAME_PORT"
          [[ -z "$DEPLOY_VNC_PORT" ]] && missing="$missing DEPLOY_VNC_PORT"
          [[ -z "$DEPLOY_STEAM_AUTH_PORT" ]] && missing="$missing DEPLOY_STEAM_AUTH_PORT"
          if [[ -n "$missing" ]]; then
            echo "::error::Missing secrets:$missing"
            echo "Configure these in Settings ‚Üí Environments ‚Üí pr-preview"
            exit 1
          fi

          cat > .env << EOF
          # Auto-generated by GitHub Actions
          # PR Preview: #$PR_NUMBER
          IMAGE_VERSION=$IMAGE_TAG
          STEAM_USERNAME=${{ secrets.DEPLOY_STEAM_USERNAME }}
          STEAM_PASSWORD=${{ secrets.DEPLOY_STEAM_PASSWORD }}
          STEAM_REFRESH_TOKEN=${{ secrets.DEPLOY_STEAM_REFRESH_TOKEN }}
          VNC_PASSWORD=${{ secrets.DEPLOY_VNC_PASSWORD }}
          GAME_PORT=$DEPLOY_GAME_PORT
          VNC_PORT=$DEPLOY_VNC_PORT
          STEAM_AUTH_PORT=$DEPLOY_STEAM_AUTH_PORT
          DISABLE_RENDERING=true
          EOF
          sed -i 's/^          //' .env

      - name: Create deploy directory
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0 # v1.2.4
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: mkdir -p ~/srv/pr-${{ inputs.pr_number }}

      - name: Copy files to server
        uses: appleboy/scp-action@ff85246acaad7bdce478db94a363cd2bf7c90345 # v1.0.0
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          source: "docker-compose.yml,.env"
          target: ~/srv/pr-${{ inputs.pr_number }}

      - name: Pull and restart containers
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0 # v1.2.4
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            set -e
            cd ~/srv/pr-${{ inputs.pr_number }}

            echo "Pulling images..."
            docker compose pull

            echo "Stopping containers..."
            docker compose down --timeout 30 || true

            echo "Setting up steam-auth..."
            docker compose run --rm steam-auth setup

            echo "Starting containers..."
            docker compose up -d

            echo "Cleanup..."
            docker image prune -f

      - name: Verify deployment
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0 # v1.2.4
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            set -e
            cd ~/srv/pr-${{ inputs.pr_number }}

            echo "Waiting for startup..."
            sleep 30

            echo "Health check..."
            if docker compose ps | grep -qE "unhealthy|Exit"; then
              echo "Container health check failed"
              docker compose logs --tail=50
              exit 1
            fi
            docker compose ps

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
        run: |
          gh pr comment "$PR_NUMBER" --body "## üöÄ PR Preview Deployed

          **Server Image:** \`sdvd/server:$IMAGE_TAG\`

          The preview server has been deployed and is running.

          ---
          *Deployed from commit ${{ needs.validate-pr.outputs.pr_sha }}*"

      - name: Build summary
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
        run: |
          echo "### PR Server Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`sdvd/server:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** pr-$PR_NUMBER" >> $GITHUB_STEP_SUMMARY

      - name: Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_NUMBER: ${{ inputs.pr_number }}
          PR_TITLE: ${{ needs.validate-pr.outputs.pr_title }}
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            jq -n \
              --arg pr_num "$PR_NUMBER" \
              --arg pr_title "$PR_TITLE" \
              --arg tag "$IMAGE_TAG" \
              '{
                embeds: [{
                  title: "PR Preview Deployed",
                  color: 16753920,
                  fields: [
                    {name: "PR", value: ("#" + $pr_num + " - " + $pr_title)},
                    {name: "Image", value: ("`sdvd/server:" + $tag + "`")}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi

  deploy-docs:
    name: Deploy PR Docs
    needs: [validate-pr, build-server]
    if: inputs.deploy_docs == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.validate-pr.outputs.pr_sha }}

      - name: Login to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract OpenAPI spec from PR Docker image
        env:
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
        run: |
          docker pull "sdvd/server:$IMAGE_TAG"
          CONTAINER_ID=$(docker create "sdvd/server:$IMAGE_TAG")
          mkdir -p docs/assets
          docker cp "$CONTAINER_ID:/data/openapi.json" docs/assets/openapi.json
          docker rm "$CONTAINER_ID"

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0

      - name: Install dependencies
        run: bun install
        working-directory: docs

      - name: Build documentation
        env:
          VITEPRESS_BASE: /server/pr-${{ inputs.pr_number }}/
        run: bun run build
        working-directory: docs

      - name: Deploy to GitHub Pages (PR subdirectory)
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          # Note: This creates a PR-specific subdirectory
          # For full implementation, you'd need to fetch existing pages content
          # and merge the PR docs into a subdirectory
          echo "PR docs built successfully"
          echo "For full deployment, configure GitHub Pages to support multiple deployments"
          echo "or use a service like Netlify/Vercel for PR previews"

      - name: Build summary
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          echo "### PR Docs Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "Documentation has been built from the PR branch." >> $GITHUB_STEP_SUMMARY

  notify-completion:
    name: Notify Completion
    needs: [validate-pr, build-server, build-steam-service, build-discord-bot]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment build results on PR
        if: needs.build-server.result == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr_number }}
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
          DEPLOY_SERVER: ${{ inputs.deploy_server }}
          DEPLOY_DOCS: ${{ inputs.deploy_docs }}
        run: |
          # Only comment if we're not deploying (deployment job has its own comment)
          if [ "$DEPLOY_SERVER" != "true" ]; then
            gh pr comment "$PR_NUMBER" --body "## üê≥ PR Preview Images Built

          | Image | Tag |
          |-------|-----|
          | sdvd/server | \`$IMAGE_TAG\` |
          | sdvd/steam-service | \`$IMAGE_TAG\` |
          | sdvd/discord-bot | \`$IMAGE_TAG\` |

          **Pull command:**
          \`\`\`bash
          docker pull sdvd/server:$IMAGE_TAG
          \`\`\`

          ---
          *Built from commit ${{ needs.validate-pr.outputs.pr_sha }}*"
          fi

      - name: Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_NUMBER: ${{ inputs.pr_number }}
          PR_TITLE: ${{ needs.validate-pr.outputs.pr_title }}
          IMAGE_TAG: ${{ needs.validate-pr.outputs.image_tag }}
          BUILD_RESULT: ${{ needs.build-server.result }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            if [ "$BUILD_RESULT" = "success" ]; then
              COLOR=5763719
              TITLE="PR Preview Built"
            else
              COLOR=15158332
              TITLE="PR Preview Build Failed"
            fi

            jq -n \
              --arg title "$TITLE" \
              --arg pr_num "$PR_NUMBER" \
              --arg pr_title "$PR_TITLE" \
              --arg tag "$IMAGE_TAG" \
              --argjson color "$COLOR" \
              '{
                embeds: [{
                  title: $title,
                  color: $color,
                  fields: [
                    {name: "PR", value: ("#" + $pr_num + " - " + $pr_title)},
                    {name: "Image Tag", value: ("`" + $tag + "`")}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
