name: Build Preview

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'
      - 'tests/**'
      - '*.md'
      - 'LICENSE'

# Prevent multiple builds from running simultaneously
concurrency:
  group: build-preview
  cancel-in-progress: true

permissions: {}

jobs:
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      next_version: ${{ steps.version.outputs.next_version }}
      preview_version: ${{ steps.version.outputs.preview_version }}
      preview_number: ${{ steps.version.outputs.preview_number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # Fetch all history for version calculation

      - name: Get next version from release-please PR
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Try to get version from release-please PR
          echo "Looking for release-please PR..."
          PR_TITLE=$(gh pr list --label "autorelease: pending" --json title --jq '.[0].title // empty')

          if [ -n "$PR_TITLE" ]; then
            echo "Found release-please PR: $PR_TITLE"
            # Extract version from PR title (e.g., "chore(master): release 1.4.0" or "chore: release 1.4.0")
            NEXT_VERSION=$(echo "$PR_TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          fi

          # Fallback: if no PR or couldn't extract version, bump patch from current release
          if [ -z "$NEXT_VERSION" ]; then
            echo "No release-please PR found, bumping patch version"
            LATEST_TAG=$(git tag -l 'sdvd-server-v*' --sort=-version:refname | head -n 1)
            if [ -z "$LATEST_TAG" ]; then
              LATEST_TAG=$(git tag -l 'v*' --sort=-version:refname | grep -v 'preview' | head -n 1)
            fi
            echo "Latest release tag: $LATEST_TAG"
            CURRENT_VERSION=$(echo "$LATEST_TAG" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            NEXT_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
          fi

          echo "Next version: $NEXT_VERSION"

          # Get current preview tag to determine counter
          PREVIEW_TAG=$(git tag -l 'preview-*' | head -n 1)
          if [ -n "$PREVIEW_TAG" ]; then
            # Parse existing tag: preview-{version}.{counter}
            PREVIEW_TAG_VERSION=$(echo "$PREVIEW_TAG" | sed 's/preview-\(.*\)\.[0-9]*$/\1/')
            PREVIEW_TAG_COUNTER=$(echo "$PREVIEW_TAG" | sed 's/.*\.\([0-9]*\)$/\1/')
            echo "Found preview tag: $PREVIEW_TAG (version: $PREVIEW_TAG_VERSION, counter: $PREVIEW_TAG_COUNTER)"

            if [ "$PREVIEW_TAG_VERSION" == "$NEXT_VERSION" ]; then
              # Same version, increment counter
              PREVIEW_NUMBER=$((PREVIEW_TAG_COUNTER + 1))
            else
              # Version changed, reset counter
              PREVIEW_NUMBER=1
            fi
          else
            # No preview tag exists yet
            PREVIEW_NUMBER=1
          fi
          echo "Preview number: $PREVIEW_NUMBER"

          # Create preview version
          PREVIEW_VERSION="$NEXT_VERSION-preview.$PREVIEW_NUMBER"
          echo "Preview version: $PREVIEW_VERSION"

          # Export variables
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "preview_version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT
          echo "preview_number=$PREVIEW_NUMBER" >> $GITHUB_OUTPUT

  build-server-preview:
    name: Build and Push Server Preview
    needs: calculate-version
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Update version in files (for Docker build only)
        run: |
          PREVIEW_VERSION="${{ needs.calculate-version.outputs.preview_version }}"

          # Update manifest.json
          sed -i "s/\"Version\": \".*\"/\"Version\": \"$PREVIEW_VERSION\"/" mod/JunimoServer/manifest.json

          # Update csproj
          sed -i "s|<Version>.*</Version>|<Version>$PREVIEW_VERSION</Version>|g" mod/JunimoServer/JunimoServer.csproj

          echo "Updated files to version $PREVIEW_VERSION (not committed)"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to DockerHub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: sdvd/server
          tags: |
            type=raw,value=preview
            type=raw,value=${{ needs.calculate-version.outputs.preview_version }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: true
          sbom: true
          secrets: |
            steam_username=${{ secrets.STEAM_USERNAME }}
            steam_password=${{ secrets.STEAM_PASSWORD }}
            steam_refresh_token=${{ secrets.STEAM_REFRESH_TOKEN }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update preview tracking tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create/update tracking tag atomically (format: preview-{version}.{counter})
          TRACKING_TAG="preview-${{ needs.calculate-version.outputs.next_version }}.${{ needs.calculate-version.outputs.preview_number }}"
          git tag -f "$TRACKING_TAG"
          git push origin "$TRACKING_TAG" --force

      - name: Build summary
        run: |
          echo "### Preview Build Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.calculate-version.outputs.preview_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Next Release:** \`${{ needs.calculate-version.outputs.next_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/server:preview\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/server:${{ needs.calculate-version.outputs.preview_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull sdvd/server:preview" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Get merged PR info
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/pulls --jq '.[0] // empty')
          if [ -n "$PR_JSON" ]; then
            echo "number=$(echo "$PR_JSON" | jq -r '.number')" >> $GITHUB_OUTPUT
            echo "title=$(echo "$PR_JSON" | jq -r '.title')" >> $GITHUB_OUTPUT
            echo "url=$(echo "$PR_JSON" | jq -r '.html_url')" >> $GITHUB_OUTPUT
          fi

      - name: Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_URL: ${{ steps.pr.outputs.url }}
          PREVIEW_VERSION: ${{ needs.calculate-version.outputs.preview_version }}
        run: |
          if [ -n "$PR_NUMBER" ]; then
            # Use jq to safely build JSON with user-provided content
            jq -n \
              --arg version "$PREVIEW_VERSION" \
              --arg pr_num "$PR_NUMBER" \
              --arg pr_title "$PR_TITLE" \
              --arg pr_url "$PR_URL" \
              '{
                embeds: [{
                  title: "Preview Build Published",
                  color: 16753920,
                  fields: [
                    {name: "Version", value: "`\($version)`"},
                    {name: "Changes", value: "[#\($pr_num) - \($pr_title)](\($pr_url))"}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          else
            jq -n \
              --arg version "$PREVIEW_VERSION" \
              '{
                embeds: [{
                  title: "Preview Build Published",
                  color: 16753920,
                  fields: [
                    {name: "Version", value: "`\($version)`"}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi

  build-steam-service-preview:
    name: Build Steam Service Preview
    needs: calculate-version
    uses: ./.github/workflows/build-image.yml
    with:
      image_name: sdvd/steam-service
      context: ./tools/steam-service
      dockerfile: ./tools/steam-service/Dockerfile
      version: ${{ needs.calculate-version.outputs.preview_version }}
      additional_tag: preview
      cache_scope: steam-service
    secrets: inherit

  build-discord-bot-preview:
    name: Build Discord Bot Preview
    needs: calculate-version
    uses: ./.github/workflows/build-image.yml
    with:
      image_name: sdvd/discord-bot
      context: ./tools/discord-bot
      dockerfile: ./tools/discord-bot/Dockerfile
      version: ${{ needs.calculate-version.outputs.preview_version }}
      additional_tag: preview
      cache_scope: discord-bot
    secrets: inherit

  build-docs:
    name: Build Preview Docs
    needs: build-server-preview
    uses: ./.github/workflows/build-docs.yml
    with:
      version: preview
      image_tag: preview
    secrets: inherit

  deploy-docs:
    name: Deploy Documentation
    needs: build-docs
    uses: ./.github/workflows/deploy-docs.yml
    with:
      version: preview
    secrets: inherit
