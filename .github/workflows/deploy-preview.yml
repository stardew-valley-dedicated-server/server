name: Deploy Preview to VPS

on:
  workflow_run:
    workflows: ["Preview Build"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:
    inputs:
      skip_graceful_shutdown:
        description: 'Skip graceful shutdown (emergency deploy)'
        required: false
        default: false
        type: boolean

# Only one deployment at a time
concurrency:
  group: vps-deploy
  cancel-in-progress: false

permissions: {}

env:
  DEPLOY_PATH: /srv/sdvd/preview

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    # Only run if build succeeded (for workflow_run trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          sparse-checkout: |
            docker-compose.yml
          sparse-checkout-cone-mode: false

      - name: Setup SSH
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add VPS to known hosts
        env:
          SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" "$SSH_HOST" >> ~/.ssh/known_hosts

      # ============================================================
      # PLACEHOLDER: Future Graceful Shutdown Hook
      # ============================================================
      # This step will be expanded to:
      # 1. Query server API for active players
      # 2. Send in-game notification about pending restart
      # 3. Wait for current in-game day to end
      # 4. Allow configurable timeout before forcing shutdown
      - name: Graceful shutdown preparation
        if: inputs.skip_graceful_shutdown != true
        env:
          SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          echo "::notice::Graceful shutdown hook placeholder - implement server notification here"
          # Future implementation example:
          # ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" << 'SHUTDOWN_SCRIPT'
          #   # Check if players are online via server API
          #   # Send notification: "Server restarting in 5 minutes"
          #   # Wait for day-end or timeout
          # SHUTDOWN_SCRIPT

      - name: Create .env file on VPS
        env:
          SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          STEAM_USERNAME: ${{ secrets.DEPLOY_STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.DEPLOY_STEAM_PASSWORD }}
          STEAM_REFRESH_TOKEN: ${{ secrets.DEPLOY_STEAM_REFRESH_TOKEN }}
          VNC_PASSWORD: ${{ secrets.DEPLOY_VNC_PASSWORD }}
        run: |
          PORT="${SSH_PORT:-22}"
          # Create deploy directory if it doesn't exist
          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" "mkdir -p ${{ env.DEPLOY_PATH }}"

          # Create .env file with secrets
          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" "cat > ${{ env.DEPLOY_PATH }}/.env" << ENVFILE
          # Auto-generated by GitHub Actions deploy workflow
          # DO NOT EDIT MANUALLY - changes will be overwritten on next deploy

          IMAGE_VERSION=preview

          # Steam credentials
          # Authentication options (use one or both):
          # - STEAM_PASSWORD: Steam account password
          # - STEAM_REFRESH_TOKEN: OAuth refresh token (preferred, password ignored if set)
          STEAM_USERNAME=$STEAM_USERNAME
          STEAM_PASSWORD=$STEAM_PASSWORD
          STEAM_REFRESH_TOKEN=$STEAM_REFRESH_TOKEN

          # VNC access
          VNC_PASSWORD=$VNC_PASSWORD

          # Server configuration
          GAME_PORT=24642
          VNC_PORT=5800
          STEAM_AUTH_PORT=3001
          DISABLE_RENDERING=true
          ENVFILE

      - name: Copy docker-compose.yml to VPS
        env:
          SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          scp -P "${SSH_PORT:-22}" docker-compose.yml "$SSH_USER@$SSH_HOST:${{ env.DEPLOY_PATH }}/docker-compose.yml"

      - name: Pull and restart containers
        env:
          SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" << DEPLOY_SCRIPT
          set -e
          cd ${{ env.DEPLOY_PATH }}

          echo "Pulling latest images..."
          docker compose pull

          echo "Stopping existing containers..."
          docker compose down --timeout 30 || true

          echo "Starting containers with new images..."
          docker compose up -d

          echo "Cleaning up old images..."
          docker image prune -f

          echo "Deployment complete!"
          docker compose ps
          DEPLOY_SCRIPT

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          # Wait for containers to start
          sleep 30

          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" << 'VERIFY_SCRIPT'
          cd /srv/sdvd/preview

          # Check container status
          if docker compose ps | grep -qE "unhealthy|Exit"; then
            echo "::error::One or more containers are unhealthy or exited"
            docker compose logs --tail=50
            exit 1
          fi

          echo "All containers running successfully"
          docker compose ps
          VERIFY_SCRIPT

      - name: Build summary
        run: |
          echo "### Deployment to VPS Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/server:preview\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/steam-service:preview\`" >> $GITHUB_STEP_SUMMARY

      - name: Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            jq -n \
              --arg commit "${GITHUB_SHA:0:7}" \
              '{
                embeds: [{
                  title: "Preview Server Deployed",
                  color: 3066993,
                  fields: [
                    {name: "Status", value: "Server is now running the latest preview build"},
                    {name: "Commit", value: "`\($commit)`"}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi

      - name: Discord notification (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            jq -n \
              --arg commit "${GITHUB_SHA:0:7}" \
              '{
                embeds: [{
                  title: "Preview Server Deployment Failed",
                  color: 15158332,
                  fields: [
                    {name: "Status", value: "Deployment encountered an error - check GitHub Actions logs"},
                    {name: "Commit", value: "`\($commit)`"}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
