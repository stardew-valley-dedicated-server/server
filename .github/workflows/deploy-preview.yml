name: Deploy Preview to VPS

on:
  workflow_run:
    workflows: ["Preview Build"]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:
    inputs:
      skip_graceful_shutdown:
        description: 'Skip graceful shutdown (emergency deploy)'
        required: false
        default: false
        type: boolean

# Queue deployments - don't cancel in-progress deploys (could leave server in broken state)
concurrency:
  group: vps-deploy
  cancel-in-progress: false

permissions: {}

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    # Only run if build succeeded (for workflow_run trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: read

    env:
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/srv/sdvd/preview' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          sparse-checkout: |
            docker-compose.yml
          sparse-checkout-cone-mode: false

      # ============================================================
      # PLACEHOLDER: Future Graceful Shutdown Hook
      # ============================================================
      # This step will be expanded to:
      # 1. Query server API for active players
      # 2. Send in-game notification about pending restart
      # 3. Wait for current in-game day to end
      # 4. Allow configurable timeout before forcing shutdown
      - name: Graceful shutdown preparation
        if: inputs.skip_graceful_shutdown != true
        run: |
          echo "::notice::Graceful shutdown hook placeholder - implement server notification here"

      - name: Create .env file
        run: |
          echo "::group::Generate .env file"
          cat > .env << EOF
          # Auto-generated by GitHub Actions deploy workflow
          IMAGE_VERSION=preview
          STEAM_USERNAME=${{ secrets.DEPLOY_STEAM_USERNAME }}
          STEAM_PASSWORD=${{ secrets.DEPLOY_STEAM_PASSWORD }}
          STEAM_REFRESH_TOKEN=${{ secrets.DEPLOY_STEAM_REFRESH_TOKEN }}
          VNC_PASSWORD=${{ secrets.DEPLOY_VNC_PASSWORD }}
          GAME_PORT=24642
          VNC_PORT=5800
          STEAM_AUTH_PORT=3001
          DISABLE_RENDERING=true
          EOF
          sed -i 's/^          //' .env
          echo "::endgroup::"

      - name: Create deploy directory
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f # v1.2.2
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: mkdir -p ${{ env.DEPLOY_PATH }}

      - name: Copy files to server
        uses: appleboy/scp-action@ff85246acaad7bdce478db94a363cd2bf7c90345 # v1.0.0
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          source: "docker-compose.yml,.env"
          target: ${{ env.DEPLOY_PATH }}

      - name: Pull and restart containers
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f # v1.2.2
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "::group::Pull latest images"
            docker compose pull
            echo "::endgroup::"

            echo "::group::Stop existing containers"
            docker compose down --timeout 30 || true
            echo "::endgroup::"

            echo "::group::Start containers"
            docker compose up -d
            echo "::endgroup::"

            echo "::group::Cleanup old images"
            docker image prune -f
            echo "::endgroup::"

      - name: Verify deployment
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f # v1.2.2
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          script: |
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "::group::Wait for containers to start"
            sleep 30
            echo "::endgroup::"

            echo "::group::Check container health"
            if docker compose ps | grep -qE "unhealthy|Exit"; then
              echo "::error::One or more containers are unhealthy or exited"
              docker compose logs --tail=50
              exit 1
            fi
            echo "All containers running successfully"
            docker compose ps
            echo "::endgroup::"

      - name: Build summary
        run: |
          echo "### Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/server:preview\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`sdvd/steam-service:preview\`" >> $GITHUB_STEP_SUMMARY

      - name: Discord notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            jq -n \
              --arg commit "${GITHUB_SHA:0:7}" \
              '{
                embeds: [{
                  title: "Preview Server Deployed",
                  color: 3066993,
                  fields: [
                    {name: "Status", value: "Server is now running the latest preview build"},
                    {name: "Commit", value: "`\($commit)`"}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi

      - name: Discord notification (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            jq -n \
              --arg commit "${GITHUB_SHA:0:7}" \
              '{
                embeds: [{
                  title: "Preview Server Deployment Failed",
                  color: 15158332,
                  fields: [
                    {name: "Status", value: "Deployment encountered an error - check GitHub Actions logs"},
                    {name: "Commit", value: "`\($commit)`"}
                  ]
                }]
              }' | curl -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
          fi
