# CI/CD & Releases

This guide covers the automated build and release pipeline for contributors and maintainers.

## Overview

The project uses **GitHub Flow** with automated CI/CD:

| Workflow | Trigger | Output |
|----------|---------|--------|
| **PR Validation** | Pull requests → `master` | Build validation only |
| **Preview Build** | Push to `master` | `sdvd/server:preview` + versioned preview tags |
| **Production Release** | Merge Release PR | GitHub release + `sdvd/server:latest` + version tag |

## Development Workflow

### Creating Features

```bash
# 1. Create feature branch from master
git checkout master && git pull
git checkout -b feat/my-feature

# 2. Make changes with conventional commits
git commit -m "feat: add new feature"

# 3. Open PR targeting 'master'
git push -u origin feat/my-feature
```

After merging to `master`, a preview build automatically publishes to DockerHub.

### Creating Releases

Releases are created via **release-please**, which automates version bumping:

1. **Merge PRs to master** → Preview builds publish automatically
2. **release-please creates a Release PR** → Contains version bumps + CHANGELOG
3. **Review the Release PR** → Check version and changelog
4. **Merge the Release PR** → Production release published

**How release-please works:**
- Analyzes commits since last release tag
- Creates a new branch with version bump commits
- Opens PR: `release-please--branches--master` → `master`
- When merged, creates GitHub release + Docker images

**Example:**
```
Last release: v1.0.2
Commits: feat A, fix B, feat C
Release PR created: 1.0.2 → 1.1.0
Merge Release PR → v1.1.0 published
```

## Conventional Commits

Commit messages determine version bumps:

```
<type>: <description>

[optional body]
```

**Version Bumping:**
- `feat:` → Minor bump (1.0.0 → 1.1.0)
- `fix:` → Patch bump (1.0.0 → 1.0.1)
- `feat!:` or `BREAKING CHANGE:` → Major bump (1.0.0 → 2.0.0)
- `docs:`, `chore:`, `refactor:` → No version bump

**Examples:**
```bash
git commit -m "feat: add cabin management system"
git commit -m "fix: resolve memory leak in server loop"
git commit -m "docs: update installation guide"
```

## Preview Versioning

Preview builds use semantic versioning: `X.Y.Z-preview.N`

- **Base version**: Calculated from commits since last release
- **Preview number**: GitHub run number (auto-incremented)
- **Tags**: Both `preview` (rolling) and versioned (immutable)

**Example:**
```
Last release: v1.0.2
Merge feat A → 1.1.0-preview.47
Merge feat B → 1.2.0-preview.48 (another feat, now minor bump)
Merge fix C  → 1.2.0-preview.49
```

Preview versions show what the next release will be.

## Batching Features

You can merge multiple features before releasing:

```
Day 1: Merge feat A → 1.1.0-preview.1 published
       Release PR created (1.0.2 → 1.1.0)

Day 2: Merge feat B → 1.2.0-preview.2 published
       Release PR updated (1.0.2 → 1.2.0)

Day 3: Test preview.2 thoroughly

Day 4: Merge Release PR → v1.2.0 released
```

The Release PR automatically updates as you merge more commits.

## Repository Setup (Maintainers)

### 1. Configure GitHub Secrets

Go to **Settings → Secrets → Actions** and add:

| Secret | Description |
|--------|-------------|
| `DOCKERHUB_USERNAME` | DockerHub username |
| `DOCKERHUB_TOKEN` | [Create token](https://hub.docker.com/settings/security) |
| `STEAM_USER` | Steam username (for game download during build) |
| `STEAM_PASS` | Steam password |

### 2. Configure Branch Protection

**Protect `master`:**
- Settings → Branches → Add rule
- Pattern: `master`
- Enable:
  - ✅ Require pull request before merging
  - ✅ Require status checks: `Validate Build`
  - ✅ Require approvals: 1

### 3. Configure Fork PR Protection

Settings → Actions → General → Fork pull request workflows:
- Select "Require approval for all outside collaborators"

## Docker Image Tags

| Tag | Use Case | Stability |
|-----|----------|-----------|
| `sdvd/server:latest` | Production | Stable |
| `sdvd/server:1.0.2` | Specific release | Stable, immutable |
| `sdvd/server:preview` | Latest preview | Unstable, rolling |
| `sdvd/server:1.1.0-preview.47` | Specific preview | Unstable, immutable |

## Troubleshooting

**Build fails with Steam auth error:**
- Verify `STEAM_USER` and `STEAM_PASS` secrets are set
- Ensure Steam account owns Stardew Valley

**Version doesn't bump correctly:**
- Check commit messages follow conventional format
- Use `git log <last-tag>..HEAD` to verify commits
- Commits without `feat:` or `fix:` don't bump version

**Docker push fails:**
- Verify `DOCKERHUB_TOKEN` has read/write permissions
- Check repository `sdvd/server` exists on DockerHub

**Release PR not created:**
- Ensure commits since last tag include version-bumping types (`feat:`, `fix:`)
- Check GitHub Actions logs for errors

## Resources

- [Conventional Commits](https://www.conventionalcommits.org/)
- [GitHub Flow](https://docs.github.com/en/get-started/quickstart/github-flow)
- [Semantic Versioning](https://semver.org/)
- [release-please](https://github.com/googleapis/release-please)
