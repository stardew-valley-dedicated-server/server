# Decompiling

## Why decompile Stardew Valley?

In most cases, *decompiling* the game isnâ€™t necessary, since Visual Studio can provide on-the-fly access to decompiled game code through its **Peek Definition** feature. However, if you need to explore the game logic in more detail or work with it inside a separate project, decompiling can be useful.

Recompiling the game is currently more of a long-term goal than a working solution. In theory, having a fully recompilable version of Stardew Valley would allow us to generate our own *.pdb debugging symbols, making step-through debugging with breakpoints inside Stardew Valley code possible. It could also enable us to  upgrade from .NET 6 internally, which would possibly come with performance improvements and access to newer language features for server-side mods.

At the moment, this should be viewed as exploratory work and documentation of what might be achievable, rather than a supported or fully functional workflow.

## Decompile

To decompile Stardew Valley run this script:

```sh
bash ./tools/decompile-sdv.sh
```

## Compile

> [!NOTE]
> This section is work in progress, only writing down some details to pick up again later on.

To compile the decompiled Stardew Valley:

1. Decompile using method from above
2. Fix immediately visible compiler bugs
   - On 1.6.15 this took me a few minutes, should not cause infinite follow-up errors
   - Commented out some code, and had 2-3 references to non-existent stuff
3. Create `global.json` in decomp root
   - Content: `{"sdk":{"version": "6.0.403"}}`
4. Adjust decomp .csproj file to use
   - Modify: `<LangVersion>preview</LangVersion>`
5. Copy remaining files from steam installation into `<decompRoot>/bin`

Below are *some* fixes that I still have around, just writing them down for convenience:

**HashUtility**

Used LLM to rewrite it, switching System.Data.HashFunction -> System.IO.Hashing.XxHash32

```csharp
using System;
using System.IO.Hashing;
using System.Text;

namespace StardewValley.Hashing;

public class HashUtility : IHashUtility
{
    public int GetDeterministicHashCode(string value)
    {
        if (value == null) throw new ArgumentNullException(nameof(value));
        byte[] data = Encoding.UTF8.GetBytes(value);
        return GetDeterministicHashCode(data);
    }

    public int GetDeterministicHashCode(params int[] values)
    {
        if (values == null) throw new ArgumentNullException(nameof(values));
        byte[] array = new byte[values.Length * 4];
        Buffer.BlockCopy(values, 0, array, 0, array.Length);
        return GetDeterministicHashCode(array);
    }

    public int GetDeterministicHashCode(byte[] data)
    {
        if (data == null) throw new ArgumentNullException(nameof(data));
        byte[] hash = XxHash32.Hash(data);
        return BitConverter.ToInt32(hash, 0);
    }
}
```

**PropertyType**

Don't remember the exact error wording, but when seeing this with conversion issues, most likely just needs `.ToString()` slapped onto
